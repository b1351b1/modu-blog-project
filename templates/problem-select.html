<!DOCTYPE html>
<html lang="ko-KR">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¬¸ì œ ì„ íƒ - ì˜ì–´êµìœ¡ìš© ë¸”ë¡œê·¸</title>
  <link rel="stylesheet" href="/static/css/common.css">
  <link rel="stylesheet" href="/static/css/problem-select.css">
</head>

<body>
  <!-- header -->
  <div class="header">
    <h1><a href="/">ì˜ì–´êµìœ¡ìš© ë¸”ë¡œê·¸</a></h1>
    <div class="header-click">
      <span id="user-nickname" style="margin-right: 10px; font-weight: 600;"></span>
      <a href="/templates/index.html">ê²Œì‹œíŒ</a>
      <a href="/templates/mypage.html">ë§ˆì´í˜ì´ì§€</a>
      <a href="/templates/problem-register.html" id="problem-register-link" style="display: none;">ë¬¸ì œ ë“±ë¡</a>
      <button type="button" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
  <!-- // header -->

  <div class="main">
    <h2 class="main-title">ë¬¸ì œ ì„ íƒí•˜ê¸°</h2>
    <p class="main-desc">ì˜ì–´ ê¸°ì¶œ ë¬¸ì œë¥¼ ì„ íƒí•˜ì—¬ ë‚´ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€í•˜ì„¸ìš”</p>

    <div class="problem-select-container">
      <!-- ì„ íƒ ì˜ì—­ -->
      <div class="select-section">
        <div class="select-group">
          <label for="year-select">ğŸ“… ì—°ë„ ì„ íƒ</label>
          <select id="year-select">
            <option value="">ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>

        <div class="select-group">
          <label for="month-select">ğŸ“† ì›” ì„ íƒ</label>
          <select id="month-select" disabled>
            <option value="">ë¨¼ì € ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>

        <div class="select-group">
          <label for="number-select">ğŸ”¢ ë¬¸ì œ ë²ˆí˜¸ ì„ íƒ</label>
          <select id="number-select" disabled>
            <option value="">ë¨¼ì € ì›”ì„ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>
      </div>

      <!-- ë¬¸ì œ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
      <div class="problem-info" id="problem-info" style="display: none;">
        <div class="problem-card">
          <div class="problem-icon">ğŸ“</div>
          <h3 class="problem-title" id="problem-title"></h3>
          <div class="problem-difficulty" id="problem-difficulty"></div>
          <button type="button" class="btn btn-primary" id="add-problem-btn">
            ë‚´ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€í•˜ê¸°
          </button>
        </div>
      </div>

      <!-- ë¡œë”© ë©”ì‹œì§€ -->
      <div class="loading-message" id="loading-message" style="display: none;">
        <p>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
      <div class="error-message" id="error-message" style="display: none;">
        <p>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>

  <!-- footer -->
  <p class="footer">Copyright 2025. ì˜ì–´êµìœ¡ìš© ë¸”ë¡œê·¸ All rights reserved.</p>
  <!-- //footer -->

  <script>
    const API_BASE_URL = 'http://localhost:8000';
    let selectedProblem = null;
    let allProblems = [];

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    function checkLoginStatus() {
      const token = localStorage.getItem('access_token');
      const userRole = localStorage.getItem('user_role');
      const userNickname = localStorage.getItem('user_nickname');
      
      if (token && userNickname) {
        // ë‹‰ë„¤ì„ í‘œì‹œ
        document.getElementById('user-nickname').textContent = `${userNickname}ë‹˜`;
        
        // ê´€ë¦¬ìì¸ ê²½ìš° ë¬¸ì œ ë“±ë¡ ë§í¬ í‘œì‹œ
        if (userRole === 'admin') {
          document.getElementById('problem-register-link').style.display = 'inline-block';
        }
      }
    }
    
    // ë¡œê·¸ì•„ì›ƒ
    document.getElementById('logout-btn').addEventListener('click', function() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user_role');
      localStorage.removeItem('user_name');
      localStorage.removeItem('user_nickname');
      window.location.href = 'intro.html';
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ë„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadYears() {
      try {
        const response = await fetch(`${API_BASE_URL}/problems/?limit=1000`);
        const data = await response.json();
        
        if (response.ok && data.problems.length > 0) {
          allProblems = data.problems;
          
          // ìœ ë‹ˆí¬í•œ ì—°ë„ ì¶”ì¶œ ë° ì •ë ¬
          const years = [...new Set(data.problems.map(p => p.year))].sort((a, b) => b - a);
          
          const yearSelect = document.getElementById('year-select');
          years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = `${year}ë…„`;
            yearSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('ì—°ë„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        showError();
      }
    }

    // ì—°ë„ ì„ íƒ ì‹œ ì›” ëª©ë¡ ì—…ë°ì´íŠ¸
    document.getElementById('year-select').addEventListener('change', function() {
      const year = parseInt(this.value);
      const monthSelect = document.getElementById('month-select');
      const numberSelect = document.getElementById('number-select');
      
      // ì´ˆê¸°í™”
      monthSelect.innerHTML = '<option value="">ì›”ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      numberSelect.innerHTML = '<option value="">ë¨¼ì € ì›”ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      numberSelect.disabled = true;
      hideProblemInfo();
      
      if (!year) {
        monthSelect.disabled = true;
        return;
      }
      
      // í•´ë‹¹ ì—°ë„ì˜ ì›” ì¶”ì¶œ
      const months = [...new Set(
        allProblems
          .filter(p => p.year === year)
          .map(p => p.month)
      )].sort((a, b) => a - b);
      
      months.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = `${month}ì›”`;
        monthSelect.appendChild(option);
      });
      
      monthSelect.disabled = false;
    });

    // ì›” ì„ íƒ ì‹œ ë¬¸ì œ ë²ˆí˜¸ ëª©ë¡ ì—…ë°ì´íŠ¸
    document.getElementById('month-select').addEventListener('change', function() {
      const year = parseInt(document.getElementById('year-select').value);
      const month = parseInt(this.value);
      const numberSelect = document.getElementById('number-select');
      
      // ì´ˆê¸°í™”
      numberSelect.innerHTML = '<option value="">ë¬¸ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
      hideProblemInfo();
      
      if (!month) {
        numberSelect.disabled = true;
        return;
      }
      
      // í•´ë‹¹ ì—°ë„, ì›”ì˜ ë¬¸ì œ ë²ˆí˜¸ ì¶”ì¶œ
      const numbers = allProblems
        .filter(p => p.year === year && p.month === month)
        .map(p => ({ number: p.number, problem_id: p.problem_id }))
        .sort((a, b) => a.number - b.number);
      
      numbers.forEach(item => {
        const option = document.createElement('option');
        option.value = item.problem_id;
        option.textContent = `${item.number}ë²ˆ`;
        numberSelect.appendChild(option);
      });
      
      numberSelect.disabled = false;
    });

    // ë¬¸ì œ ë²ˆí˜¸ ì„ íƒ ì‹œ ë¬¸ì œ ì •ë³´ í‘œì‹œ
    document.getElementById('number-select').addEventListener('change', function() {
      const problemId = parseInt(this.value);
      
      if (!problemId) {
        hideProblemInfo();
        return;
      }
      
      const problem = allProblems.find(p => p.problem_id === problemId);
      
      if (problem) {
        selectedProblem = problem;
        displayProblemInfo(problem);
      }
    });

    // ë¬¸ì œ ì •ë³´ í‘œì‹œ
    function displayProblemInfo(problem) {
      document.getElementById('problem-title').textContent = problem.title;
      
      // ë‚œì´ë„ í‘œì‹œ
      const difficultyDiv = document.getElementById('problem-difficulty');
      const difficultyText = problem.difficulty || 'ì¤‘';
      const stars = getDifficultyStars(difficultyText);
      
      difficultyDiv.innerHTML = `
        <span class="difficulty-label">ë‚œì´ë„:</span>
        <span class="difficulty-stars">${stars}</span>
        <span class="difficulty-text">(${difficultyText})</span>
      `;
      
      document.getElementById('problem-info').style.display = 'block';
      document.getElementById('loading-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
    }

    // ë‚œì´ë„ì— ë”°ë¥¸ ë³„ ê°œìˆ˜ ë°˜í™˜
    function getDifficultyStars(difficulty) {
      const starMap = {
        'ìƒ': 'â­â­â­',
        'ì¤‘': 'â­â­',
        'í•˜': 'â­'
      };
      return starMap[difficulty] || 'â­â­';
    }

    // ë¬¸ì œ ì •ë³´ ìˆ¨ê¸°ê¸°
    function hideProblemInfo() {
      document.getElementById('problem-info').style.display = 'none';
      selectedProblem = null;
    }

    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    function showError() {
      document.getElementById('error-message').style.display = 'block';
      document.getElementById('loading-message').style.display = 'none';
      document.getElementById('problem-info').style.display = 'none';
    }

    // ë¬¸ì œ ì¶”ê°€ ë²„íŠ¼ í´ë¦­
    document.getElementById('add-problem-btn').addEventListener('click', async function() {
      const token = localStorage.getItem('access_token');
      
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
      }
      
      if (!selectedProblem) {
        alert('ë¬¸ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const button = this;
        button.disabled = true;
        button.textContent = 'ì¶”ê°€ ì¤‘...';
        
        const response = await fetch(`${API_BASE_URL}/problems/my`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ problem_id: selectedProblem.problem_id })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('ë¬¸ì œê°€ ë‚´ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
          
          // ì„ íƒ ì´ˆê¸°í™”
          document.getElementById('year-select').value = '';
          document.getElementById('month-select').innerHTML = '<option value="">ë¨¼ì € ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
          document.getElementById('month-select').disabled = true;
          document.getElementById('number-select').innerHTML = '<option value="">ë¨¼ì € ì›”ì„ ì„ íƒí•˜ì„¸ìš”</option>';
          document.getElementById('number-select').disabled = true;
          hideProblemInfo();
          
        } else {
          if (response.status === 400 && data.detail.includes('already')) {
            alert('ì´ë¯¸ ì¶”ê°€í•œ ë¬¸ì œì…ë‹ˆë‹¤.');
          } else {
            alert('ë¬¸ì œ ì¶”ê°€ ì‹¤íŒ¨: ' + data.detail);
          }
        }
        
        button.disabled = false;
        button.textContent = 'ë‚´ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€í•˜ê¸°';
        
      } catch (error) {
        console.error('ë¬¸ì œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error);
        alert('ë¬¸ì œë¥¼ ì¶”ê°€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        
        const button = document.getElementById('add-problem-btn');
        button.disabled = false;
        button.textContent = 'ë‚´ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€í•˜ê¸°';
      }
    });

    // ì´ˆê¸° ë¡œë“œ
    checkLoginStatus();
    loadYears();
  </script>
</body>

</html>