<!DOCTYPE html>
<html lang="ko-KR">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë§ˆì´í˜ì´ì§€ - ì˜ì–´êµìœ¡ìš© ë¸”ë¡œê·¸</title>
  <link rel="stylesheet" href="/static/css/common.css">
  <link rel="stylesheet" href="/static/css/mypage.css">
</head>

<body>
  <!-- header -->
  <div class="header">
    <h1><a href="/">ì˜ì–´êµìœ¡ìš© ë¸”ë¡œê·¸</a></h1>
    <div class="header-click">
      <span id="user-nickname" style="margin-right: 10px; font-weight: 600;"></span>
      <a href="/templates/index.html">ê²Œì‹œíŒ</a>
      <a href="/templates/problem-select.html" id="problem-select-link">ë¬¸ì œì„ íƒ</a>
      <a href="/templates/popular-problems.html" id="popular-link" style="display: none;">ì¸ê¸°ë¬¸ì œ</a>
      <button type="button" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
  <!-- // header -->

  <div class="main">
    <h2 class="main-title">ë§ˆì´í˜ì´ì§€</h2>
    <p class="main-desc">ë‚´ê°€ ì„ íƒí•œ ë¬¸ì œì™€ ê°œì¸ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tab-menu">
      <button class="tab-btn active" data-tab="problems">ğŸ“š ë‚´ ë¬¸ì œ ëª©ë¡</button>
      <button class="tab-btn" data-tab="profile">ğŸ‘¤ ê°œì¸ì •ë³´ ê´€ë¦¬</button>
    </div>

    <!-- ë¬¸ì œ ì„¹ì…˜ -->
    <div class="tab-content active" id="problems-section">
      <!-- í†µê³„ ì •ë³´ -->
      <div class="stats-container">
        <div class="stat-box">
          <div class="stat-icon">ğŸ“š</div>
          <div class="stat-info">
            <p class="stat-label">ì„ íƒí•œ ë¬¸ì œ</p>
            <p class="stat-value" id="total-problems">0ê°œ</p>
          </div>
        </div>
      </div>

      <!-- ë¡œë”© -->
      <div id="loading" style="text-align: center; padding: 60px 20px;">
        <p style="color: #999;">ë¬¸ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <!-- ë¬¸ì œ ëª©ë¡ -->
      <div class="problem-list-container" id="problem-list-container" style="display: none;">
        <div class="problem-list" id="problem-list">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination" id="pagination" style="margin-top: 40px; justify-content: center;">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>
      </div>

      <!-- ë¹ˆ ìƒíƒœ -->
      <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-icon">ğŸ“­</div>
        <h3 class="empty-title">ì„ íƒí•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="empty-desc">
          ë¬¸ì œ ì„ íƒ í˜ì´ì§€ì—ì„œ ê´€ì‹¬ìˆëŠ” ë¬¸ì œë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.<br>
          ì„ íƒí•œ ë¬¸ì œëŠ” ì—¬ê¸°ì— ì €ì¥ë˜ì–´ ì–¸ì œë“ ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        <a href="/templates/problem-select.html" class="btn btn-primary">ë¬¸ì œ ì„ íƒí•˜ëŸ¬ ê°€ê¸°</a>
      </div>
    </div>

    <!-- ê°œì¸ì •ë³´ ì„¹ì…˜ -->
    <div class="tab-content" id="profile-section">
      <div class="profile-container">
        <!-- ë‚´ ì •ë³´ ì¡°íšŒ -->
        <div class="profile-card">
          <h3 class="profile-title">ë‚´ ì •ë³´</h3>
          <div class="profile-info">
            <div class="info-item">
              <span class="info-label">ì•„ì´ë””:</span>
              <span class="info-value" id="user-name">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ì´ë©”ì¼:</span>
              <span class="info-value" id="user-email">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ë‹‰ë„¤ì„:</span>
              <span class="info-value" id="user-nick">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ì—­í• :</span>
              <span class="info-value" id="user-role-display">-</span>
            </div>
          </div>
        </div>

        <!-- ë‹‰ë„¤ì„ ìˆ˜ì • -->
        <div class="profile-card">
          <h3 class="profile-title">ë‹‰ë„¤ì„ ë³€ê²½</h3>
          <form id="nickname-form">
            <div class="form-group">
              <label for="new-nickname">ìƒˆ ë‹‰ë„¤ì„</label>
              <input type="text" id="new-nickname" placeholder="ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" required minlength="2" maxlength="50">
            </div>
            <button type="submit" class="btn btn-primary">ë‹‰ë„¤ì„ ë³€ê²½</button>
          </form>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
        <div class="profile-card">
          <h3 class="profile-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
          <form id="password-form">
            <div class="form-group">
              <label for="current-password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" id="current-password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" required>
            </div>
            <div class="form-group">
              <label for="new-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)" required minlength="4" maxlength="50">
            </div>
            <div class="form-group">
              <label for="confirm-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <input type="password" id="confirm-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required>
            </div>
            <button type="submit" class="btn btn-primary">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- footer -->
  <p class="footer">Copyright 2025. ì˜ì–´êµìœ¡ìš© ë¸”ë¡œê·¸ All rights reserved.</p>
  <!-- //footer -->

  <script>
    const API_BASE_URL = 'http://localhost:8000';
    let currentPage = 1;
    const limit = 10;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ í™•ì¸
    window.addEventListener('DOMContentLoaded', function() {
      checkLoginAndInit();
      setupTabs();
    });

    // íƒ­ ë©”ë‰´ ì„¤ì •
    function setupTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');

          // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ ì»¨í…ì¸ ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));

          // í´ë¦­í•œ íƒ­ í™œì„±í™”
          this.classList.add('active');
          document.getElementById(`${tabName}-section`).classList.add('active');

          // ê°œì¸ì •ë³´ íƒ­ í´ë¦­ ì‹œ ì •ë³´ ë¡œë“œ
          if (tabName === 'profile') {
            loadUserProfile();
          }
        });
      });
    }

    // ë¡œê·¸ì¸ í™•ì¸ ë° ì´ˆê¸°í™”
    function checkLoginAndInit() {
      const token = localStorage.getItem('access_token');
      const userRole = localStorage.getItem('user_role');
      const userNickname = localStorage.getItem('user_nickname');
      
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
      }

      // ë‹‰ë„¤ì„ í‘œì‹œ
      if (userNickname) {
        document.getElementById('user-nickname').textContent = `${userNickname}ë‹˜`;
      }
      
      // ê´€ë¦¬ì ì—¬ë¶€ì— ë”°ë¼ í—¤ë” ë§í¬ ë³€ê²½
      if (userRole === 'admin') {
        // ê´€ë¦¬ì: ë¬¸ì œì„ íƒ ìˆ¨ê¸°ê³  ì¸ê¸°ë¬¸ì œ ë³´ì´ê¸°
        document.getElementById('problem-select-link').style.display = 'none';
        document.getElementById('popular-link').style.display = 'inline';
      } else {
        // ì¼ë°˜ ì‚¬ìš©ì: ë¬¸ì œì„ íƒ ë³´ì´ê³  ì¸ê¸°ë¬¸ì œ ìˆ¨ê¸°ê¸°
        document.getElementById('problem-select-link').style.display = 'inline';
        document.getElementById('popular-link').style.display = 'none';
      }

      // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
      loadMyProblems();
    }

    // ë¡œê·¸ì•„ì›ƒ
    document.getElementById('logout-btn').addEventListener('click', function() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user_role');
      localStorage.removeItem('user_name');
      localStorage.removeItem('user_nickname');
      window.location.href = 'intro.html';
    });

    // ===== ë¬¸ì œ ì„¹ì…˜ =====
    // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
    async function loadMyProblems() {
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/problems/my?page=${currentPage}&limit=${limit}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        // ë¡œë”© ìˆ¨ê¸°ê¸°
        document.getElementById('loading').style.display = 'none';
        
        if (response.ok && data.my_problems && data.my_problems.length > 0) {
          // í†µê³„ ì—…ë°ì´íŠ¸
          document.getElementById('total-problems').textContent = `${data.total}ê°œ`;
          
          // ë¬¸ì œ ëª©ë¡ í‘œì‹œ
          displayProblems(data.my_problems);
          document.getElementById('problem-list-container').style.display = 'block';
          document.getElementById('empty-state').style.display = 'none';
          
          // í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ
          displayPagination(data.total, currentPage, limit);
        } else {
          document.getElementById('empty-state').style.display = 'block';
          document.getElementById('problem-list-container').style.display = 'none';
        }
      } catch (error) {
        console.error('ë¬¸ì œ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
      }
    }

    // ë¬¸ì œ ëª©ë¡ í‘œì‹œ
    function displayProblems(problems) {
      const listContainer = document.getElementById('problem-list');
      
      const html = problems.map(item => {
        const problem = item.problem;
        const difficultyStars = getDifficultyStars(problem.difficulty);
        const firstSelectedDate = item.first_selected_at
          ? new Date(item.first_selected_at).toLocaleDateString('ko-KR')
          : '-';
        const lastSelectedDate = item.last_selected_at
          ? new Date(item.last_selected_at).toLocaleDateString('ko-KR')
          : '-';
        
        return `
          <div class="problem-card" data-user-problem-id="${item.user_problem_id}">
            <div class="problem-card-header">
              <div class="problem-info">
                <span class="problem-badge">${problem.year}ë…„ ${problem.month}ì›”</span>
                <span class="problem-number">${problem.number}ë²ˆ</span>
              </div>
              <div class="problem-difficulty">
                <span class="difficulty-stars">${difficultyStars}</span>
                <span class="difficulty-text">${problem.difficulty}</span>
              </div>
            </div>
            
            <h3 class="problem-title">${problem.title}</h3>
            
            <div class="problem-dates">
              <div class="date-item">
                <span class="date-label">ì²˜ìŒ ì„ íƒ:</span>
                <span class="date-value">${firstSelectedDate}</span>
              </div>
              <div class="date-item">
                <span class="date-label">ë§ˆì§€ë§‰ ì„ íƒ:</span>
                <span class="date-value">${lastSelectedDate}</span>
              </div>
            </div>
            
            ${problem.file_url ? `
              <div class="problem-file">
                <a href="${API_BASE_URL}${problem.file_url}" target="_blank" class="file-link">
                  ğŸ“„ ë¬¸ì œ íŒŒì¼ ë³´ê¸°
                </a>
              </div>
            ` : ''}
            
            <button type="button" class="btn-delete" onclick="deleteProblem(${item.user_problem_id})">
              ì‚­ì œ
            </button>
          </div>
        `;
      }).join('');
      
      listContainer.innerHTML = html;
    }

    // ë‚œì´ë„ì— ë”°ë¥¸ ë³„ ê°œìˆ˜ ë°˜í™˜
    function getDifficultyStars(difficulty) {
      const starMap = {
        'ìƒ': 'â­â­â­',
        'ì¤‘': 'â­â­',
        'í•˜': 'â­'
      };
      return starMap[difficulty] || 'â­â­';
    }

    // ë¬¸ì œ ì‚­ì œ
    async function deleteProblem(userProblemId) {
      if (!confirm('ì •ë§ ì´ ë¬¸ì œë¥¼ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/problems/my/${userProblemId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          alert('ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // í˜„ì¬ í˜ì´ì§€ì˜ ë¬¸ì œê°€ í•˜ë‚˜ì˜€ê³ , 1í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ ì´ì „ í˜ì´ì§€ë¡œ
          const problemCards = document.querySelectorAll('.problem-card');
          if (problemCards.length === 1 && currentPage > 1) {
            currentPage--;
          }
          
          loadMyProblems();
        } else {
          const data = await response.json();
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.detail);
        }
      } catch (error) {
        console.error('ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
        alert('ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ
    function displayPagination(total, page, limit) {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(total / limit);
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // ì´ì „ í˜ì´ì§€
      if (page > 1) {
        html += `<a href="#" onclick="changePage(${page - 1}); return false;" class="page-btn">â€¹ ì´ì „</a>`;
      }
      
      // í˜ì´ì§€ ë²ˆí˜¸ (í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ Â±2)
      const startPage = Math.max(1, page - 2);
      const endPage = Math.min(totalPages, page + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === page ? 'active' : '';
        html += `<a href="#" class="page-num ${activeClass}" onclick="changePage(${i}); return false;">${i}</a>`;
      }
      
      // ë‹¤ìŒ í˜ì´ì§€
      if (page < totalPages) {
        html += `<a href="#" onclick="changePage(${page + 1}); return false;" class="page-btn">ë‹¤ìŒ â€º</a>`;
      }
      
      pagination.innerHTML = html;
    }

    // í˜ì´ì§€ ë³€ê²½
    function changePage(page) {
      currentPage = page;
      loadMyProblems();
      window.scrollTo(0, 0);
    }

    // ===== ê°œì¸ì •ë³´ ì„¹ì…˜ =====
    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    async function loadUserProfile() {
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/auth/me`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const user = await response.json();
          document.getElementById('user-name').textContent = user.name;
          document.getElementById('user-email').textContent = user.email;
          document.getElementById('user-nick').textContent = user.nickname;
          document.getElementById('user-role-display').textContent = user.role === 'admin' ? 'ê´€ë¦¬ì' : 'ì‚¬ìš©ì';
        } else {
          const data = await response.json();
          alert('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.detail);
        }
      } catch (error) {
        console.error('ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
        alert('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë‹‰ë„¤ì„ ë³€ê²½
    document.getElementById('nickname-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const newNickname = document.getElementById('new-nickname').value.trim();
      
      if (newNickname.length < 2) {
        alert('ë‹‰ë„¤ì„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/auth/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nickname: newNickname })
        });
        
        if (response.ok) {
          alert('ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
          localStorage.setItem('user_nickname', newNickname);
          document.getElementById('user-nickname').textContent = `${newNickname}ë‹˜`;
          loadUserProfile();
          document.getElementById('new-nickname').value = '';
        } else {
          const data = await response.json();
          alert('ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨: ' + data.detail);
        }
      } catch (error) {
        console.error('ë‹‰ë„¤ì„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
        alert('ë‹‰ë„¤ì„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
    document.getElementById('password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (newPassword.length < 4) {
        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/auth/password`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            new_password_confirm: confirmPassword 
          })
        });
        
        if (response.ok) {
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          localStorage.removeItem('access_token');
          localStorage.removeItem('user_role');
          localStorage.removeItem('user_name');
          localStorage.removeItem('user_nickname');
          window.location.href = 'login.html';
        } else {
          const data = await response.json();
          alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨: ' + data.detail);
        }
      } catch (error) {
        console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
        alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  </script>
</body>

</html>