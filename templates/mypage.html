<!DOCTYPE html>
<html lang="ko-KR">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마이페이지 - 영어교육용 블로그</title>
  <link rel="stylesheet" href="/static/css/common.css">
  <link rel="stylesheet" href="/static/css/mypage.css">
</head>

<body>
  <!-- header -->
  <div class="header">
    <h1><a href="/">영어교육용 블로그</a></h1>
    <div class="header-click">
      <span id="user-nickname" style="margin-right: 10px; font-weight: 600;"></span>
      <a href="/templates/index.html">게시판</a>
      <a href="/templates/problem-select.html" id="problem-select-link">문제선택</a>
      <a href="/templates/popular-problems.html" id="popular-link" style="display: none;">인기문제</a>
      <button type="button" id="logout-btn">로그아웃</button>
    </div>
  </div>
  <!-- // header -->

  <div class="main">
    <h2 class="main-title">마이페이지</h2>
    <p class="main-desc">내가 선택한 문제와 개인정보를 관리하세요</p>

    <!-- 탭 메뉴 -->
    <div class="tab-menu">
      <button class="tab-btn active" data-tab="problems">📚 내 문제 목록</button>
      <button class="tab-btn" data-tab="profile">👤 개인정보 관리</button>
    </div>

    <!-- 문제 섹션 -->
    <div class="tab-content active" id="problems-section">
      <!-- 통계 정보 -->
      <div class="stats-container">
        <div class="stat-box">
          <div class="stat-icon">📚</div>
          <div class="stat-info">
            <p class="stat-label">선택한 문제</p>
            <p class="stat-value" id="total-problems">0개</p>
          </div>
        </div>
      </div>

      <!-- 로딩 -->
      <div id="loading" style="text-align: center; padding: 60px 20px;">
        <p style="color: #999;">문제 목록을 불러오는 중...</p>
      </div>

      <!-- 문제 목록 -->
      <div class="problem-list-container" id="problem-list-container" style="display: none;">
        <div class="problem-list" id="problem-list">
          <!-- JavaScript로 동적 생성 -->
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination" id="pagination" style="margin-top: 40px; justify-content: center;">
          <!-- JavaScript로 동적 생성 -->
        </div>
      </div>

      <!-- 빈 상태 -->
      <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-icon">📭</div>
        <h3 class="empty-title">선택한 문제가 없습니다</h3>
        <p class="empty-desc">
          문제 선택 페이지에서 관심있는 문제를 선택해보세요.<br>
          선택한 문제는 여기에 저장되어 언제든지 확인할 수 있습니다.
        </p>
        <a href="/templates/problem-select.html" class="btn btn-primary">문제 선택하러 가기</a>
      </div>
    </div>

    <!-- 개인정보 섹션 -->
    <div class="tab-content" id="profile-section">
      <div class="profile-container">
        <!-- 내 정보 조회 -->
        <div class="profile-card">
          <h3 class="profile-title">내 정보</h3>
          <div class="profile-info">
            <div class="info-item">
              <span class="info-label">아이디:</span>
              <span class="info-value" id="user-name">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">이메일:</span>
              <span class="info-value" id="user-email">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">닉네임:</span>
              <span class="info-value" id="user-nick">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">역할:</span>
              <span class="info-value" id="user-role-display">-</span>
            </div>
          </div>
        </div>

        <!-- 닉네임 수정 -->
        <div class="profile-card">
          <h3 class="profile-title">닉네임 변경</h3>
          <form id="nickname-form">
            <div class="form-group">
              <label for="new-nickname">새 닉네임</label>
              <input type="text" id="new-nickname" placeholder="새 닉네임을 입력하세요" required minlength="2" maxlength="50">
            </div>
            <button type="submit" class="btn btn-primary">닉네임 변경</button>
          </form>
        </div>

        <!-- 비밀번호 변경 -->
        <div class="profile-card">
          <h3 class="profile-title">비밀번호 변경</h3>
          <form id="password-form">
            <div class="form-group">
              <label for="current-password">현재 비밀번호</label>
              <input type="password" id="current-password" placeholder="현재 비밀번호" required>
            </div>
            <div class="form-group">
              <label for="new-password">새 비밀번호</label>
              <input type="password" id="new-password" placeholder="새 비밀번호 (4자 이상)" required minlength="4" maxlength="50">
            </div>
            <div class="form-group">
              <label for="confirm-password">새 비밀번호 확인</label>
              <input type="password" id="confirm-password" placeholder="새 비밀번호 확인" required>
            </div>
            <button type="submit" class="btn btn-primary">비밀번호 변경</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- footer -->
  <p class="footer">Copyright 2025. 영어교육용 블로그 All rights reserved.</p>
  <!-- //footer -->

  <script>
    const API_BASE_URL = 'http://localhost:8000';
    let currentPage = 1;
    const limit = 10;

    // 페이지 로드 시 로그인 확인
    window.addEventListener('DOMContentLoaded', function() {
      checkLoginAndInit();
      setupTabs();
    });

    // 탭 메뉴 설정
    function setupTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');

          // 모든 탭 버튼과 컨텐츠에서 active 클래스 제거
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));

          // 클릭한 탭 활성화
          this.classList.add('active');
          document.getElementById(`${tabName}-section`).classList.add('active');

          // 개인정보 탭 클릭 시 정보 로드
          if (tabName === 'profile') {
            loadUserProfile();
          }
        });
      });
    }

    // 로그인 확인 및 초기화
    function checkLoginAndInit() {
      const token = localStorage.getItem('access_token');
      const userRole = localStorage.getItem('user_role');
      const userNickname = localStorage.getItem('user_nickname');
      
      if (!token) {
        alert('로그인이 필요합니다.');
        window.location.href = 'login.html';
        return;
      }

      // 닉네임 표시
      if (userNickname) {
        document.getElementById('user-nickname').textContent = `${userNickname}님`;
      }
      
      // 관리자 여부에 따라 헤더 링크 변경
      if (userRole === 'admin') {
        // 관리자: 문제선택 숨기고 인기문제 보이기
        document.getElementById('problem-select-link').style.display = 'none';
        document.getElementById('popular-link').style.display = 'inline';
      } else {
        // 일반 사용자: 문제선택 보이고 인기문제 숨기기
        document.getElementById('problem-select-link').style.display = 'inline';
        document.getElementById('popular-link').style.display = 'none';
      }

      // 문제 목록 로드
      loadMyProblems();
    }

    // 로그아웃
    document.getElementById('logout-btn').addEventListener('click', function() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user_role');
      localStorage.removeItem('user_name');
      localStorage.removeItem('user_nickname');
      window.location.href = 'intro.html';
    });

    // ===== 문제 섹션 =====
    // 문제 목록 로드
    async function loadMyProblems() {
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/problems/my?page=${currentPage}&limit=${limit}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        // 로딩 숨기기
        document.getElementById('loading').style.display = 'none';
        
        if (response.ok && data.my_problems && data.my_problems.length > 0) {
          // 통계 업데이트
          document.getElementById('total-problems').textContent = `${data.total}개`;
          
          // 문제 목록 표시
          displayProblems(data.my_problems);
          document.getElementById('problem-list-container').style.display = 'block';
          document.getElementById('empty-state').style.display = 'none';
          
          // 페이지네이션 표시
          displayPagination(data.total, currentPage, limit);
        } else {
          document.getElementById('empty-state').style.display = 'block';
          document.getElementById('problem-list-container').style.display = 'none';
        }
      } catch (error) {
        console.error('문제 목록 로드 중 오류:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
      }
    }

    // 문제 목록 표시
    function displayProblems(problems) {
      const listContainer = document.getElementById('problem-list');
      
      const html = problems.map(item => {
        const problem = item.problem;
        const difficultyStars = getDifficultyStars(problem.difficulty);
        const firstSelectedDate = item.first_selected_at
          ? new Date(item.first_selected_at).toLocaleDateString('ko-KR')
          : '-';
        const lastSelectedDate = item.last_selected_at
          ? new Date(item.last_selected_at).toLocaleDateString('ko-KR')
          : '-';
        
        return `
          <div class="problem-card" data-user-problem-id="${item.user_problem_id}">
            <div class="problem-card-header">
              <div class="problem-info">
                <span class="problem-badge">${problem.year}년 ${problem.month}월</span>
                <span class="problem-number">${problem.number}번</span>
              </div>
              <div class="problem-difficulty">
                <span class="difficulty-stars">${difficultyStars}</span>
                <span class="difficulty-text">${problem.difficulty}</span>
              </div>
            </div>
            
            <h3 class="problem-title">${problem.title}</h3>
            
            <div class="problem-dates">
              <div class="date-item">
                <span class="date-label">처음 선택:</span>
                <span class="date-value">${firstSelectedDate}</span>
              </div>
              <div class="date-item">
                <span class="date-label">마지막 선택:</span>
                <span class="date-value">${lastSelectedDate}</span>
              </div>
            </div>
            
            ${problem.file_url ? `
              <div class="problem-file">
                <a href="${API_BASE_URL}${problem.file_url}" target="_blank" class="file-link">
                  📄 문제 파일 보기
                </a>
              </div>
            ` : ''}
            
            <button type="button" class="btn-delete" onclick="deleteProblem(${item.user_problem_id})">
              삭제
            </button>
          </div>
        `;
      }).join('');
      
      listContainer.innerHTML = html;
    }

    // 난이도에 따른 별 개수 반환
    function getDifficultyStars(difficulty) {
      const starMap = {
        '상': '⭐⭐⭐',
        '중': '⭐⭐',
        '하': '⭐'
      };
      return starMap[difficulty] || '⭐⭐';
    }

    // 문제 삭제
    async function deleteProblem(userProblemId) {
      if (!confirm('정말 이 문제를 목록에서 삭제하시겠습니까?')) {
        return;
      }
      
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/problems/my/${userProblemId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          alert('문제가 삭제되었습니다.');
          
          // 현재 페이지의 문제가 하나였고, 1페이지가 아니면 이전 페이지로
          const problemCards = document.querySelectorAll('.problem-card');
          if (problemCards.length === 1 && currentPage > 1) {
            currentPage--;
          }
          
          loadMyProblems();
        } else {
          const data = await response.json();
          alert('삭제 실패: ' + data.detail);
        }
      } catch (error) {
        console.error('문제 삭제 중 오류:', error);
        alert('문제 삭제 중 오류가 발생했습니다.');
      }
    }

    // 페이지네이션 표시
    function displayPagination(total, page, limit) {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(total / limit);
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // 이전 페이지
      if (page > 1) {
        html += `<a href="#" onclick="changePage(${page - 1}); return false;" class="page-btn">‹ 이전</a>`;
      }
      
      // 페이지 번호 (현재 페이지 기준 ±2)
      const startPage = Math.max(1, page - 2);
      const endPage = Math.min(totalPages, page + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === page ? 'active' : '';
        html += `<a href="#" class="page-num ${activeClass}" onclick="changePage(${i}); return false;">${i}</a>`;
      }
      
      // 다음 페이지
      if (page < totalPages) {
        html += `<a href="#" onclick="changePage(${page + 1}); return false;" class="page-btn">다음 ›</a>`;
      }
      
      pagination.innerHTML = html;
    }

    // 페이지 변경
    function changePage(page) {
      currentPage = page;
      loadMyProblems();
      window.scrollTo(0, 0);
    }

    // ===== 개인정보 섹션 =====
    // 사용자 정보 로드
    async function loadUserProfile() {
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/auth/me`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const user = await response.json();
          document.getElementById('user-name').textContent = user.name;
          document.getElementById('user-email').textContent = user.email;
          document.getElementById('user-nick').textContent = user.nickname;
          document.getElementById('user-role-display').textContent = user.role === 'admin' ? '관리자' : '사용자';
        } else {
          const data = await response.json();
          alert('정보를 불러오는데 실패했습니다: ' + data.detail);
        }
      } catch (error) {
        console.error('정보 로드 중 오류:', error);
        alert('정보를 불러오는 중 오류가 발생했습니다.');
      }
    }

    // 닉네임 변경
    document.getElementById('nickname-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const newNickname = document.getElementById('new-nickname').value.trim();
      
      if (newNickname.length < 2) {
        alert('닉네임은 2자 이상이어야 합니다.');
        return;
      }
      
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/auth/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nickname: newNickname })
        });
        
        if (response.ok) {
          alert('닉네임이 변경되었습니다.');
          localStorage.setItem('user_nickname', newNickname);
          document.getElementById('user-nickname').textContent = `${newNickname}님`;
          loadUserProfile();
          document.getElementById('new-nickname').value = '';
        } else {
          const data = await response.json();
          alert('닉네임 변경 실패: ' + data.detail);
        }
      } catch (error) {
        console.error('닉네임 변경 중 오류:', error);
        alert('닉네임 변경 중 오류가 발생했습니다.');
      }
    });

    // 비밀번호 변경
    document.getElementById('password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (newPassword.length < 4) {
        alert('새 비밀번호는 4자 이상이어야 합니다.');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert('새 비밀번호가 일치하지 않습니다.');
        return;
      }
      
      try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE_URL}/auth/password`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            new_password_confirm: confirmPassword 
          })
        });
        
        if (response.ok) {
          alert('비밀번호가 변경되었습니다. 다시 로그인해주세요.');
          localStorage.removeItem('access_token');
          localStorage.removeItem('user_role');
          localStorage.removeItem('user_name');
          localStorage.removeItem('user_nickname');
          window.location.href = 'login.html';
        } else {
          const data = await response.json();
          alert('비밀번호 변경 실패: ' + data.detail);
        }
      } catch (error) {
        console.error('비밀번호 변경 중 오류:', error);
        alert('비밀번호 변경 중 오류가 발생했습니다.');
      }
    });
  </script>
</body>

</html>