<!DOCTYPE html>
<html lang="ko-KR">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시글 작성 - 영어교육용 블로그</title>
  <link rel="stylesheet" href="/static/css/common.css">
  <link rel="stylesheet" href="/static/css/table.css">
  <link rel="stylesheet" href="/static/css/write.css">
</head>

<body>
  <!-- header -->
  <div class="header">
    <h1><a href="/">영어교육용 블로그</a></h1>
    <div class="header-click">
      <span id="user-nickname" style="margin-right: 10px; font-weight: 600;"></span>
      <a href="/templates/index.html">게시판</a>
      <a href="/templates/problem-register.html">문제 등록</a>
      <button type="button" id="logout-btn">로그아웃</button>
    </div>
  </div>
  <!-- // header -->

  <div class="main">
    <h2 class="main-title">게시글 작성</h2>
    <p class="main-desc">게시글 내용을 입력해주세요. <span style="color: #999; font-size: 14px;">(관리자 전용)</span></p>

    <form id="write-form">
      <table class="table write">
        <colgroup>
          <col style="width: 120px">
          <col>
        </colgroup>
        <tbody>
          <tr>
            <th><label for="category">카테고리 <span class="required">*</span></label></th>
            <td>
              <select id="category" required>
                <option value="">카테고리를 선택하세요</option>
                <option value="입시정보">입시정보</option>
                <option value="영어지식">영어지식</option>
              </select>
            </td>
          </tr>
          <tr>
            <th><label for="board-title">제목 <span class="required">*</span></label></th>
            <td><input type="text" id="board-title" name="boardTitle" placeholder="제목을 입력하세요" required></td>
          </tr>
          <tr>
            <th><label for="board-tags">태그</label></th>
            <td>
              <input type="text" id="board-tags" name="boardTags" placeholder="태그를 입력하세요 (쉼표로 구분, 예: 수능, 입시, 전략)">
              <p class="field-desc">여러 개의 태그를 입력할 수 있습니다. 쉼표(,)로 구분해주세요.</p>
            </td>
          </tr>
          <tr>
            <th><label for="board-content">내용 <span class="required">*</span></label></th>
            <td>
              <textarea id="board-content" placeholder="게시글 내용을 입력하세요" required></textarea>
            </td>
          </tr>
          <tr>
            <th><label for="board-file">이미지 첨부</label></th>
            <td>
              <input type="file" id="board-file" accept="image/jpeg,image/png,image/jpg">
              <p class="field-desc">JPG, JPEG, PNG 파일만 업로드 가능합니다.</p>
              <div id="image-preview" style="display: none;">
                <p class="preview-label">미리보기:</p>
                <img id="preview-img" src="" alt="이미지 미리보기">
                <button type="button" id="remove-image" class="btn-remove">이미지 삭제</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="btn-group">
        <a href="/templates/index.html" class="btn">목록</a>
        <button type="submit" class="btn btn-primary">작성</button>
      </div>
    </form>
  </div>

  <!-- footer -->
  <p class="footer">Copyright 2025. 영어교육용 블로그 All rights reserved.</p>
  <!-- //footer -->

  <script>
    const API_BASE_URL = 'http://localhost:8000';
    let uploadedImageUrl = null;

    // 페이지 로드 시 권한 확인
    window.addEventListener('DOMContentLoaded', function() {
      checkAdminAccess();
    });

    // 관리자 권한 확인
    function checkAdminAccess() {
      const token = localStorage.getItem('access_token');
      const userRole = localStorage.getItem('user_role');
      
      if (!token) {
        alert('로그인이 필요합니다.');
        window.location.href = 'login.html';
        return;
      }
      
      if (userRole !== 'admin') {
        alert('관리자만 게시글을 작성할 수 있습니다.');
        window.location.href = 'index.html';
        return;
      }
    }

    const userNickname = localStorage.getItem('user_nickname');
    if (userNickname) {
      document.getElementById('user-nickname').textContent = `${userNickname}님`;
    }

    // 로그아웃
    document.getElementById('logout-btn').addEventListener('click', function() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user_role');
      localStorage.removeItem('user_name');
      localStorage.removeItem('user_nickname');
      window.location.href = 'intro.html';
    });

    // 이미지 파일 선택 시 미리보기
    document.getElementById('board-file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      
      if (!file) {
        return;
      }
      
      // 파일 형식 검증
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      if (!allowedTypes.includes(file.type)) {
        alert('JPG, JPEG, PNG 파일만 업로드 가능합니다.');
        e.target.value = '';
        return;
      }
      
      // 파일 크기 검증 (10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('이미지 크기는 10MB 이하여야 합니다.');
        e.target.value = '';
        return;
      }
      
      // 미리보기 표시
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('preview-img').src = e.target.result;
        document.getElementById('image-preview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    // 이미지 삭제 버튼
    document.getElementById('remove-image').addEventListener('click', function() {
      document.getElementById('board-file').value = '';
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('preview-img').src = '';
      uploadedImageUrl = null;
    });

    // 이미지 업로드 함수
    async function uploadImage(file) {
        const formData = new FormData();
        formData.append('image', file);  // ✅ 'file' → 'image'로 변경
        
        const token = localStorage.getItem('access_token');
        
        if (!token) {
            alert('로그인이 필요합니다.');
            return null;
        }
        
        try {
            // ✅ API_BASE_URL 사용
            const response = await fetch(`${API_BASE_URL}/blog/images`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    alert('로그인이 만료되었습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = 'login.html';
                    return null;
                }
                throw new Error('이미지 업로드 실패');
            }
            
            const data = await response.json();
            return data.image_url;
        } catch (error) {
            console.error('이미지 업로드 오류:', error);
            alert('이미지 업로드 중 오류가 발생했습니다.');
            return null;
        }
    }

    // 폼 제출
    document.getElementById('write-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const category = document.getElementById('category').value;
      const title = document.getElementById('board-title').value.trim();
      const content = document.getElementById('board-content').value.trim();
      const tagsInput = document.getElementById('board-tags').value.trim();
      
      // 유효성 검사
      if (!category) {
        alert('카테고리를 선택해주세요.');
        return;
      }
      
      if (!title) {
        alert('제목을 입력해주세요.');
        return;
      }
      
      if (title.length < 2) {
        alert('제목은 2자 이상이어야 합니다.');
        return;
      }
      
      if (!content) {
        alert('내용을 입력해주세요.');
        return;
      }
      
      if (content.length < 10) {
        alert('내용은 10자 이상이어야 합니다.');
        return;
      }
      
      // 태그 처리 (쉼표로 구분)
      let tags = [];
      if (tagsInput) {
        tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
      }
      
      try {
        // 버튼 비활성화
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '작성 중...';
        
        // ✅ 디버깅 코드 추가 시작
        const token = localStorage.getItem('access_token');
        console.log('=== 디버깅 정보 ===');
        console.log('1. 토큰 존재 여부:', !!token);
        console.log('2. 토큰 앞 20자:', token ? token.substring(0, 20) : '없음');
        console.log('3. API URL:', `${API_BASE_URL}/blog`);
        console.log('4. 전체 토큰:', token); 
        // ✅ 디버깅 코드 추가 끝

        // 이미지가 있으면 먼저 업로드
        let imageUrl = null;
        const fileInput = document.getElementById('board-file');
        if (fileInput.files.length > 0) {
          imageUrl = await uploadImage(fileInput.files[0]);
        }
        
        // 게시글 작성
        const postData = {
          title: title,
          content: content,
          category: category,
          tags: tags
        };
        
        if (imageUrl) {
          postData.image_url = imageUrl;
        }
        
        const response = await fetch(`${API_BASE_URL}/blog`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(postData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('게시글이 성공적으로 작성되었습니다!');
          window.location.href = `view.html?id=${data.id}`;
        } else {
          throw new Error(data.detail || '게시글 작성에 실패했습니다.');
        }
        
      } catch (error) {
        console.error('게시글 작성 실패:', error);
        alert('게시글 작성 중 오류가 발생했습니다: ' + error.message);
        
        // 버튼 다시 활성화
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = '작성';
      }
    });
  </script>
</body>

</html>